# 数据库需要使用的表

## 使用说明

1. 首先在一个py文件中，创建一个类，用与使用不同用户连接数据库
```python
Class 数据库连接类:
    async def 用户1连接(self):
        conn = await asyncpg.connect(
            user="user1",
            password="password1",
            database="database",
            host="host",
        )
        return conn
```
2. 在类中，创建一个不同方法，使用不同用户连接数据库
```python
连接数据库类 = 数据库连接类()
conn = await 连接数据库类.用户1连接()
```
3. 创建另一个类，用于操作数据库，继承数据库连接类
```python
Class 数据库查询类(数据库连接类):
    def __init__(self):
        super().__init__() # 继承数据库连接类
        self.conn = None # 创建一个连接对象
    async def 查询数据(self, conn):
        sql = """
        SELECT *
        FROM table"""
        data = await conn.fetch(sql)
        return data
```
4. 在类中，首先连接数据库，然后进行操作
```python
数据库查询类 = 数据库查询类()
conn = await 数据库查询类.用户1连接()
data = await 数据库查询类.查询数据(conn)
print(data)
```
5. 数据库插入类，数据库删除类，数据库更新类，都可以继承数据库连接类，然后进行操作，不再赘述

## 用户表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | varchar(20) | 用户名，主键 |
| 密码 | varchar(8) | 密码 |
| 等级 | smallint | 等级 |
| 使用容量（KB） | int | 使用容量，默认为0 |
| 昵称 | varchar(20) | 昵称，默认为用户名 |
| 头像路径 | varchar(50) | 头像路径，默认为默认头像路径 |
| 密匙 | varchar(256) | 用于登入验证token |

## 注册码表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 注册码 | varchar(20) | 注册码，主键 |
| 对应的等级 | smallint | 注册码对应的等级 |
| 是否使用 | boolean | 是否已被使用 |

需要事先生成一些注册码，用于注册时使用

## 等级表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 等级 | smallint | 等级，主键 |
| 最大容量（KB） | int | 最大容量 | 
| 最大上传文件大小（KB） | int | 最大上传文件大小 |
| 最大上传文件数量 | smallint | 最大上传文件数量 |
| 回收站保存时间（天） | smallint | 回收站保存时间 |

也需要事先生成一些等级，和对应的最大容量

## 文件夹表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | varchar(20) | 文件夹所属用户，主键，也是用户表的外键 |
| 当前文件夹id | varchar(5) | 文件夹id，主键，每个文件夹id都不一样 |
| 当前文件夹隶属：文件夹的层级关系 | text | 文件夹层级，见：[如何实现文件夹功能](如何实现文件夹功能) | 
| 文件夹名 | varchar(50) | 文件夹名，非空 |
| 文件夹创建时间 | timestamp | 文件夹创建时间，当前时间 |
| 文件夹是否被删除 | boolean | 文件夹是否被删除，默认为false |
| 文件夹密码 | varchar(8) | 文件夹密码，默认为null |

***注意***：要为每位用户创建一个视图，只能看到自己的文件夹，后续操作也是只能操作用户的视图

## 文件表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | varchar(20) | 文件所属用户，主键，也是用户表的外键 |
| 文件id | varchar | 文件id，主键，确保每个文件id都是不一样的 |
| 当前文件隶属：文件夹的层级关系 | text | 文件夹层级，见：[如何实现文件夹功能](如何实现文件夹功能)  |
| 文件名 | varchar(50) | 文件名，非空 |
| 文件类型 | varchar(20) | 文件类型 |
| 文件路径 | text | 文件路径 |
| 文件大小（KB） | int | 文件大小 |
| 文件创建时间 | timestamp | 文件创建时间 |
| 文件是否被删除 | boolean | 文件是否被删除，默认为false |

***注意***：要为每位用户创建一个视图，只能看到自己的文件，后续操作也是只能操作用户的视图

## 缩略图表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 文件类型 | varchar(20) | 文件类型，主键 |
| 缩略图路径 | text | 缩略图路径 |

## 访问日志表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| ip | varchar(32) | ip |
| 请求头 | text | 请求头 |
| 登入失败次数 | smallint | 登入失败次数 |

定时清空登入信息表，7天清空一次

## 密匙表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 密匙id | varchar(1) | 密匙id，主键，固定为1 |
| 密匙 | varchar(256) | 密匙，利用随机算法生成 |
| 过期时间 | timestamp | 密匙过期时间 |

**只储存一个密匙**

生成密匙后，设置过期时间，过期无法使用该密匙，一般设置过期时间为创建时间的10天后

## 文件夹id表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 文件夹id | varchar(5) | 文件夹id，主键，确保每个文件夹id都是不一样的 |

利用随机算法生成文件夹id，确保每个文件夹id都是不一样的

（随机id算法：0-9，a-z，A-Z，共62个字符，自增，长度为3，一共62^3+62^2+62^1=238328个id，可以创建23万个文件夹，应该够用了，如果不够用，长度加到5）

每次创建文件都在里面提取出一个id，用于创建文件夹

创建成功后，从里面移除该id

为什么要这样做？
- 因为文件夹id是唯一的，之后删除文件夹时，该id会被重新储存到文件夹id表中，确保每个文件夹id都是不一样的，并能够被重复利用
- 主要目地是减小id长度
- 文件夹路径，由文件夹id组成的，格式为`/index/文件夹id1-文件夹id2-文件夹id3-...-文件夹idn`，文件夹id之间用`-`连接，文件夹id表中的id，用于创建文件夹路径