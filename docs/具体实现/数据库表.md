# 数据库需要使用的表

## 使用说明

1. 首先在一个py文件中，创建一个类，用与使用不同用户连接数据库，由于fastapi是异步的，所以需要使用pool池连接数据库
```python
Class 数据库连接类:
    def __init__(self):
        self.pool = None # 初始化pool

    async def 用户1连接(self):
        self.pool = await asyncpg.create_pool(
            user='用户名',
            password='密码',
            database='数据库名',
            host='localhost')
```
2. 在类中，创建一个不同方法，使用不同用户连接数据库
```python
连接数据库类 = 数据库连接类()
await 连接数据库类.用户1连接() # 连接用户1
```
3. 创建另一个类，用于操作数据库，继承数据库连接类
```python
Class 数据库查询类(数据库连接类):
    def __init__(self):
        super().__init__() # 
        
    async def 查询数据1(self, id):
        sql = """
        SELECT *
        FROM table
        WHERE id = $1
        """
        async with self.pool.acquire() as conn: # 使用连接池，获取连接
            data = await conn.fetch(sql, id) # 执行sql语句
            return data # 返回数据
```
4. 在类中，首先连接数据库，然后进行操作
```python
数据库查询类 = 数据库查询类()
await 数据库查询类.用户1连接()
data = await 数据库查询类.查询数据1(id)
print(data)
```
5. 数据库插入类，数据库删除类，数据库更新类，都可以继承数据库连接类，然后进行操作，不再赘述

## **注意**
1. 创建的表，需要使用索引，提高查询速度
2. 创建表的操作，必须将其保存到文件中（sql文件，py文件都可以），以便后续使用
3. 对属性的约束，要使用域进行约束，如果不知道可以看书
4. 上面的例子，只是一个简单的例子，使用池连接数据库，我之前也没用过，所以可能有问题，需要自己学习

## 用户表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | varchar(20) | 用户名，主键 |
| 密码 | varchar(60) | 密码 |
| 等级 | smallint | 等级 |
| 使用容量（KB） | int | 使用容量，默认为0 |
| 昵称 | varchar(20) | 昵称，默认为用户名 |
| 头像路径 | varchar(50) | 头像路径，默认为默认头像路径 |

## 注册码表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 注册码 | varchar(20) | 注册码，主键 |
| 对应的等级 | smallint | 注册码对应的等级 |
| 使用次数 | smallint | 使用次数 |

需要事先生成一些注册码，用于注册时使用，注册码使用一次，使用次数减一，当使用次数为0时，注册码失效

## 等级表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 等级 | smallint | 等级，主键 |
| 最大容量（KB） | int | 最大容量 | 
| 最大上传文件大小（KB） | int | 最大上传文件大小 |
| 回收站保存时间（天） | smallint | 回收站保存时间 |

也需要事先生成一些等级，和对应的最大容量

## 文件夹表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | varchar(20) | 文件夹所属用户，主键，也是用户表的外键 |
| 文件夹id | varchar(36) | 文件夹id，主键，每个文件夹id都不一样 |
| 父级文件夹id | varchar(36) | 文件夹隶，见：[如何实现文件夹功能](如何实现文件夹功能#2-文件夹实现) | 
| 文件夹名 | varchar(50) | 文件夹名，非空 |
| 文件夹创建时间 | timestamp | 文件夹创建时间，当前时间 |
| 文件夹是否被删除 | boolean | 文件夹是否被删除，默认为false |
| 当前文件夹隶属：文件夹的层级关系 | text | 文件夹层级，见：[如何实现文件夹功能](如何实现文件夹功能#4-文件夹的层级关系) | 
| 文件夹密码 | varchar(60) | 文件夹密码，默认为null |

***注意***：
1. 要为每位用户创建一个视图，只能看到自己的文件夹，后续操作也是只能操作用户的视图
2. 文件id由算法自动生成uuid，确保每个文件id都是不一样的
4. 后续访问文件夹时，通过`/index/文件夹id`的方式访问，通过文件夹id获取数据库中文件夹的所有父类层级关系

## 文件表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | varchar(20) | 文件所属用户，主键，也是用户表的外键 |
| 文件id | varchar(36) | 文件id，主键，确保每个文件id都是不一样的 |
| 文件夹id | varchar(36) | 文件隶的文件夹，见：[如何实现文件夹功能](如何实现文件夹功能#3-文件隶属关系)  |
| 文件名 | varchar(50) | 文件名，非空 |
| 文件创建时间 | timestamp | 文件创建时间，当前时间 |
| 文件是否被删除 | boolean | 文件是否被删除，默认为false |
| 文件大小（KB） | int | 文件大小 |
| 文件路径 | text | 文件路径 |


***注意***：
1. 要为每位用户创建一个视图，只能看到自己的文件，后续操作也是只能操作用户的视图
2. 文件类型不再储存，而是通过文件名后缀判断
3. 文件夹id由算法自动生成uuid，确保每个文件夹id都是不一样的
4. 后续访问文件夹时，通过`/index/文件夹id`的方式访问，通过文件夹id，获取文件夹下的所有文件

## 垃圾桶表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | varchar(20) | 文件所属用户，主键，也是用户表的外键 |
| 文件id | varchar(36) | 文件id，主键，确保每个文件id都是不一样的 |
| 文件夹还是文件 | boolean | 文件夹还是文件，文件夹为true，文件为false |
| 放入回收站时间 | timestamp | 文件放入回收站时间 |
| 文件删除时间 | timestamp | 文件删除时间 |

***注意***：
1. 要为每位用户创建一个视图，只能看到自己的回收站，后续操作也是只能操作用户的视图
2. 删除文件时，需要修改文件表中的文件是否被删除字段，然后将文件信息插入到垃圾桶表中，并更新文件表中的文件删除时间字段

## 缩略图表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 文件类型 | varchar(20) | 文件类型，主键 |
| 缩略图路径 | text | 缩略图路径 |

## 访问日志表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| ip | varchar(32) | ip，联合主键，非空 |
| 请求头 | text | 请求头，联合主键，可以为空 |
| 登入失败次数 | smallint | 登入失败次数 |

定时清空登入信息表，7天清空一次

## 密匙表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 密匙id | varchar(1) | 密匙id，主键，固定为1 |
| 密匙 | varchar(64) | 密匙，利用随机算法生成 |
| 过期时间 | timestamp | 密匙过期时间 |

**只储存一个密匙**

生成密匙后，设置过期时间，过期无法使用该密匙，一般设置过期时间为创建时间的10天后
