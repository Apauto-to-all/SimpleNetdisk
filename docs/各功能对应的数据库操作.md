# 介绍简云网盘各功能对应的数据库操作

## 首先，简单介绍所有表

- 用户表(用户名，密码，等级，使用容量，昵称，头像路径)

- 注册码表(注册码，注册码对应的等级，使用次数)

- 等级表(等级，最大容量，文件上传最大大小，回收站保存时间)

- 文件夹表(用户名，文件夹id，父级文件夹id，文件夹名，文件夹创建时间，是否被删除，文件夹所有父类文件夹id)

- 文件表(用户名，文件id，文件所属父类文件夹id，文件名，文件上传时间，文件是否被删除，文件大小，文件储存路径，文件复制次数)

- 垃圾桶表(用户名，文件/文件夹id，文件还是文件夹，放入回收站时间，文件永久删除时间)

- 缩略图表(文件类型，缩略图路径)

- 访问日志表(ip，请求头，登入失败次数)

- 密匙表(密匙id，密匙，过期时间)

## 各功能对应的数据库操作

### 1. 登入

输入：用户名，密码（或验证码）

处理：

- 查询访问日志表，通过ip和请求头，获取失败次数，如果没有返回0，如果失败次数大于3，为网站添加验证码
- 查询用户表，如果用户存在，则返回对应的密码，验证密码是否正确
- 更新访问日志表，如果登入出现任何错误，登入失败次数+1
- 更新访问日志表，如果登入成功，失败次数清零
- 查询密匙表，如果密匙存在，并且没有过期，则返回密匙
- 否则更新密匙表，生成新密匙，返回新密匙，利用密匙创建JWT token，添加到浏览器cookie中，用于之后验证用户身份

### 2. 注册

输入：用户名，密码，二次确认密码，注册码（或验证码）

注册前的处理：

- 查询访问日志表，通过ip和请求头，获取失败次数，如果没有返回0，如果失败次数大于3，为网站添加验证码
- 查询注册码表，查询注册码是否存在，是否还有剩余次数
- 查询用户表，查询用户名是否已经被注册

注册处理：

- 查询注册码表，获取注册码对应的等级
- 插入用户表，插入用户名，密码（加密后），等级，昵称（默认为用户名），头像路径（默认为默认头像路径），用户使用容量（默认为0）
- 更新注册码表，注册码剩余次数-1
- 插入文件夹表，插入根目录文件夹
- 插入文件夹表，在根目录文件夹下创建`hello`文件夹
- 插入文件表，在`hello`文件夹下，创建`world.txt`文件，内容：`hello world！`
- 更新访问日志表，失败次数清零

### 3. 访问简云网盘页面

输入：储存在cookie中的JWT token

用户信息页面处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询用户表，获取用户信息，包括用户昵称，使用容量，连接查询等级表，获取用户等级对应的最大容量
- 查询用户表，获取用户头像路径

网盘信息页面处理：

- 查询用户表，输入：用户名，当前文件夹id；获取文件夹所有父类文件夹id，用于构造文件夹导航栏
- 查询文件夹表，输入：用户名，当前文件夹id；获取当前文件夹下的所有文件夹（排除被删除的文件夹），包括文件夹id，文件夹名，文件夹创建时间，文件夹密码（如果没有密码则为空）
- 查询文件表，输入：用户名，当前文件夹id；获取当前文件夹下的所有文件（排除被删除的文件），包括文件id，文件名，文件大小，文件类型，文件上传时间
- 查询文件夹表，获取到当前文件id的文件夹名
- 查询缩略图表，获取文件类型对应的缩略图路径，如果没有则返回默认缩略图路径

### 4. 上传文件

输入：储存在cookie中的JWT token，当前文件夹id

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件夹表，输入：用户名，当前文件夹id；验证当前文件夹是否被加密，如果被加密并且没有解密则返回错误
- 查询用户表和等级表，获取用户等级对应的文件上传最大大小，如果文件大小超过最大大小，则返回错误
- 查询用户表和等级表，获取用户的使用容量，等级对应的最大容量，如果使用容量超过最大容量，则返回错误
- 查询文件表，输入：用户名，生成的新文件id；验证文件id不存在，如果存在则重新生成
- 查询文件表，输入：用户名，当前文件夹id，文件名；验证文件名在同一文件夹下是否重复，如果命名重复则自动重命名
- 插入文件表，插入用户名，文件id，当前文件夹id，文件名，文件上传时间，文件大小，文件储存路径，文件复制次数（默认为1）
- 更新用户表，更新用户使用容量

### 5. 下载文件

输入：储存在cookie中的JWT token，文件id，当前文件夹id

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件表和文件夹表，输入：用户名，文件id；获取到文件储存的文件夹id，验证文件夹是否被加密，如果被加密并且没有解密则禁止接下来的操作
- 查询文件表，输入：用户名，文件id；获取文件储存路径和文件名

### 6. 创建文件夹

输入：储存在cookie中的JWT token，当前文件夹id，文件夹名

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件夹表，输入：用户名，当前文件夹id；查询当前文件夹是否被加密，如果被加密就无法创建文件夹
- 查询文件夹表，输入：用户名，生成的新文件夹id；验证文件夹id是否存在，如果存在则重新生成
- 查询文件夹表，输入：用户名，当前文件夹id；验证文件夹名在同一文件夹下是否重复，如果命名重复则自动重命名
- 查询文件夹表，输入：用户名，当前文件夹id；获取当前文件夹的所有父类文件夹id
- 更新文件夹表，输入：用户名，生成的新文件夹id，当前文件夹id，文件夹名，文件夹创建时间，是否被删除，文件夹所有父类文件夹id（当前文件夹的所有父类文件夹id，加上当前文件夹id）

### 7. 加密文件夹

输入：储存在cookie中的JWT token，当前文件夹id，文件夹密码

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件夹表，输入：用户名，当前文件夹id；如果当前文件夹下已经创建了文件夹，则无法加密
- 更新文件夹表，输入：用户名，当前文件夹id，密码；更新文件夹密码（加密后）

### 8. 解密文件夹

输入：储存在cookie中的JWT token，当前文件夹id，文件夹密码

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件夹表，输入：用户名，当前文件夹id；获取文件夹密码，验证密码是否正确
- 如果是永久删除文件夹密码，更新文件夹表，输入：用户名，当前文件夹id；删除文件夹密码

### 9. 删除文件夹

输入：储存在cookie中的JWT token，当前文件夹id

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件夹表，输入：用户名，当前文件夹id；验证文件夹是否被加密，如果被加密并且没有解密则无法删除
- 更新文件夹表，输入：用户名，当前文件夹id；删除文件夹，设置文件夹是否被删除属性为true
- 插入垃圾桶表，输入：用户名，当前文件夹id；插入一条被删除的文件夹信息；放入回收站时间，文件永久删除时间

### 10. 删除文件

输入：储存在cookie中的JWT token，文件id

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件表，输入：用户名，文件id；查询父类文件夹id，验证文件是否被加密，如果被加密并且没有解密则无法删除
- 更新文件表，输入：用户名，文件id；删除文件，设置文件是否被删除属性为true
- 插入垃圾桶表，输入：用户名，文件id；插入一条被删除的文件信息；放入回收站时间，文件永久删除时间

### 11. 重命名文件夹

输入：储存在cookie中的JWT token，当前文件夹id，新文件夹名

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件夹表，输入：用户名，当前文件夹id；验证文件夹是否被加密，如果被加密并且没有解密则无法重命名
- 查询文件夹表，输入：用户名，当前文件夹id；验证新文件夹名在同一文件夹下是否重复，如果命名重复则自动重命名
- 更新文件夹表，输入：用户名，当前文件夹id，新文件夹名；更新文件夹名

### 12. 重命名文件

输入：储存在cookie中的JWT token，文件id，新文件名

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询文件表，输入：用户名，文件id；验证文件是否被加密，如果被加密并且没有解密则无法重命名
- 查询文件表，输入：用户名，文件id；验证新文件名在同一文件夹下是否重复，如果命名重复则自动重命名
- 更新文件表，输入：用户名，文件id，新文件名；更新文件名

### 13. 垃圾桶页面

输入：储存在cookie中的JWT token

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在
- 查询垃圾桶表，输入：用户名；获取所有被删除的文件和文件夹信息，包括文件/文件夹id，文件/文件夹名，放入回收站时间，文件永久删除时间

### 14. 恢复文件/文件夹

输入：储存在cookie中的JWT token，文件id列表，文件夹id列表

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在

恢复文件处理：

- 更新文件表，输入：用户名，文件id；恢复文件，设置文件是否被删除属性为false
- 删除垃圾桶表，输入：用户名，文件id，是否为文件夹为false；删除被删除的文件信息

恢复文件夹处理：

- 更新文件夹表，输入：用户名，文件夹id；恢复文件夹，设置文件夹是否被删除属性为false
- 删除垃圾桶表，输入：用户名，文件夹id，是否为文件夹为true；删除被删除的文件夹信息

### 15. 永久删除文件/文件夹

输入：储存在cookie中的JWT token，文件id列表，文件夹id列表

处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在

永久删除文件夹处理：

- 查询文件表，输入：用户名，文件夹id；获取文件夹下所有文件夹id（递归获取），添加到列表中
- 删除垃圾桶表，输入：用户名，文件夹id，是否为文件夹为true；删除被删除的文件夹信息
- 查询文件夹表，输入：用户名，文件夹id；获取文件夹的文件名，用于构造新的文件名
- 更新文件夹表，输入：用户名，文件夹id，新文件夹名；更新被永久删除的文件夹名
- 查询文件表，使用文件夹下所有文件夹id（递归获取），遍历添加到文件列表中

永久删除文件处理（必须排在永久删除文件夹之后）：

- 查询文件表，输入：用户名，文件id；获取文件名，和文件储存路径
- 更新文件表，输入：用户名，文件储存路径；更新所有以此为储存路径的文件的复制次数-1
- 查询文件表，输入：用户名，文件id；获取文件复制次数，如果复制次数为0，则删除文件储存路径对应的文件
- 查询文件表，输入：用户名，文件id；获取文件大小
- 更新用户表，更新用户使用容量，如果文件被永久删除，则使用容量-文件大小
- 查询文件表，输入：用户名，文件id；查询文件名，用于构造新的文件名，用于更新被永久删除的文件名
- 更新文件表，输入：用户名，文件id，新文件名；更新被永久删除的文件名
- 删除垃圾桶表，输入：用户名，文件id，是否为文件夹为false（表示当前为文件）；如果对应文件id存在于垃圾桶表，就删除被删除的文件信息

### 16. 更新用户信息

输入：储存在cookie中的JWT token

验证：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在

更新用户昵称处理：

输入：昵称

- 更新用户表，输入：用户名，昵称；更新用户昵称

更新用户头像处理：

输入：头像文件，头像路径

- 更新用户表，输入：用户名；将用户上传的头像储存到磁盘，获取到用户头像路径，更新用户头像路径

更新用户密码处理：

输入：原密码，新密码，二次确认密码

- 查询用户表，输入：用户名；获取用户密码，验证输入的原密码是否正确
- 更新用户表，输入：用户名，新密码；更新用户密码

### 17. 复制/移动文件/文件夹的页面

输入：储存在cookie中的JWT token

验证处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在

获取所有文件夹处理：

- 查询文件夹表，输入：用户名，当前文件夹id；获取当前文件夹下的所有文件夹（排除被删除的文件夹），包括文件夹id，文件夹名，储存到列表中
- 查询文件夹表，输入：用户名，文件夹id；遍历第一步获取的列表，查询文件夹id是否被加密，如果被加密并且没有解密则去除
- 查询文件夹表，输入：用户名，当前文件夹id；如果需要复制或移动的文件夹id在当前文件夹下，也去除

### 18. 移动文件/文件夹

输入：储存在cookie中的JWT token，需要复制的文件id列表，需要复制的文件夹id列表，目标文件夹id

验证处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在

移动文件处理：

- 更新文件表，输入：用户名，文件id，目标文件夹id；更新文件所属父类文件夹id为目标文件夹id

移动文件夹处理：

- 更新文件夹表，输入：用户名，文件夹id，目标文件夹id；更新文件夹所属父类文件夹id为目标文件夹id，并且更新所有子文件夹的所有父类文件夹id属性
- 查询文件夹表，输入：用户名，文件夹id；获取文件夹下的文件夹id，添加到列表中，然后递归进行移动文件夹处理，直到没有子文件夹

### 19. 复制文件/文件夹

输入：储存在cookie中的JWT token，需要复制的文件id列表，需要复制的文件夹id列表，目标文件夹id

验证处理：

- 查询密匙表，获取密匙，使用密匙解析JWT token，获取用户名
- 查询用户表，验证用户名是否存在

复制文件处理：

- 查询文件表，输入：用户名，新文件id；验证文件id是否存在，如果存在则重新生成
- 插入文件表，输入：用户名，新文件id，目标文件夹id；插入一条新的文件信息，除了文件id，目标文件夹id，其他信息和原文件一样

复制文件夹处理：

- 查询文件夹表，输入：用户名，新文件夹id；验证文件夹id是否存在，如果存在则重新生成
- 插入文件夹表，输入：用户名，新文件夹id，目标文件夹id；插入一条新的文件夹信息，除了文件夹id，目标文件夹id，其他信息和原文件夹一样

递归复制文件和文件夹处理：

- 查询文件表，输入：用户名，文件夹id；获取文件夹下的所有文件id，添加到列表中
- 查询文件夹表，输入：用户名，文件夹id；获取文件夹下的所有文件夹id，添加到列表中
- 递归调用复制文件处理，复制文件，直到没有文件
