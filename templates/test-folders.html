<!DOCTYPE html>
<html>

<head>
    <title>æ–‡ä»¶æ ‘</title>
    <style>
        .icon::before {
            content: "ğŸ“ ";
        }

        .folder {
            margin-left: 20px;
        }

        .toggle {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            margin-right: 5px;
            border: 1px solid black;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>æ–‡ä»¶æ ‘é¡µé¢</h2>
    <h3>ç”¨æˆ·ï¼š<span id="username"></span></h3>
    <script>
        // è·å–ç”¨æˆ·å
        fetch('/get_username', {
            method: 'GET',
        })
            .then(response => response.text())  // å°†å“åº”è½¬æ¢ä¸ºæ–‡æœ¬
            .then(username => {
                document.getElementById('username').textContent = username;
            })
            .catch(error => console.error('Error:', error));
    </script>
    <h3><span id="cp_or_move"></span></h3>
    <script>
        // è·å–æ“ä½œç±»å‹
        fetch('/get_cp_or_move', {
            method: 'GET',
        })
            .then(response => response.json())  // å°†å“åº”è½¬æ¢ä¸ºJSON
            .then(data => {
                document.getElementById('cp_or_move').textContent = data.info;  // ä½¿ç”¨infoå­—æ®µæ›´æ–°å†…å®¹
            })
            .catch(error => console.error('Error:', error));
    </script>
    <div id="file-tree"></div>
    <script>
        async function getFolders(parentFolderId = '/') {
            try {
                const response = await fetch(`/getfolders?parent_folder_id=${parentFolderId}`, {
                    method: 'GET',
                    // éœ€è¦æ·»åŠ é€‚å½“çš„headersï¼Œä¾‹å¦‚ç”¨äºè®¤è¯çš„Cookie
                });
                const folders = await response.json();
                if (response.ok) {
                    return folders;
                } else {
                    throw new Error('Failed to fetch folders');
                }
            } catch (error) {
                console.error('Error fetching folders:', error);
                return {};
            }
        }

        async function buildFileTree(parentFolderId, parentElement, level = 0) {
            const folders = await getFolders(parentFolderId);
            if (Object.keys(folders).length === 0) {
                const noFolderMsg = document.createElement('div');
                noFolderMsg.textContent = 'æ— æ–‡ä»¶å¤¹';
                parentElement.appendChild(noFolderMsg);
            } else {
                Object.entries(folders).forEach(([uuid, folderName]) => {
                    // åˆ›å»ºæ–‡ä»¶å¤¹å…ƒç´ 
                    const folderElement = document.createElement('div');
                    folderElement.className = 'folder';
                    folderElement.style.marginLeft = `${level * 20}px`;

                    // åˆ›å»ºtoggleButtonå…ƒç´ 
                    const toggleButton = document.createElement('span');
                    toggleButton.className = 'toggle';
                    toggleButton.textContent = '+';
                    toggleButton.onclick = function (event) {
                        event.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
                        if (toggleButton.textContent === '+') {
                            // å±•å¼€å­æ–‡ä»¶å¤¹
                            buildFileTree(uuid, folderElement, level + 1).then(() => {
                                toggleButton.textContent = '-';
                            });
                        } else {
                            // æ”¶èµ·å­æ–‡ä»¶å¤¹
                            while (folderElement.lastChild !== folderNameElement) {
                                folderElement.removeChild(folderElement.lastChild);
                            }
                            toggleButton.textContent = '+';
                        }
                    };
                    // åˆ›å»ºæŒ‰é’®å…ƒç´ ï¼Œç§»åŠ¨æˆ–å¤åˆ¶
                    var is_cp_or_move = false;// ç§»åŠ¨ä¸ºfalseï¼Œå¤åˆ¶ä¸ºtrue
                    // åˆ›å»ºæ“ä½œæŒ‰é’®
                    const actionButton = document.createElement('button');
                    actionButton.id = uuid;
                    var cp_or_move_test = document.getElementById('cp_or_move').textContent;
                    if (cp_or_move_test == 'å¤åˆ¶ ï¼š é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹') {
                        is_cp_or_move = true;
                        actionButton.textContent = 'å¤åˆ¶åˆ°æ­¤æ–‡ä»¶å¤¹';
                    } else if (cp_or_move_test == 'ç§»åŠ¨ ï¼š é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹') {
                        is_cp_or_move = false;
                        actionButton.textContent = 'ç§»åŠ¨åˆ°æ­¤æ–‡ä»¶å¤¹';
                    } else {
                        is_cp_or_move = null;
                        actionButton.textContent = 'æœªçŸ¥æ“ä½œ';
                    }
                    // ä¸ºæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
                    actionButton.onclick = function () {
                        // åœ¨è¿™é‡Œæ·»åŠ ç§»åŠ¨æˆ–å¤åˆ¶æ–‡ä»¶åˆ°æ–‡ä»¶å¤¹çš„é€»è¾‘
                        if (is_cp_or_move != null) {
                            // ç§»åŠ¨æ–‡ä»¶
                            if (is_cp_or_move == false) {
                                fetch(`/move_to_folder?target_folder_id=${uuid}`, {
                                    method: 'GET',
                                    credentials: 'include', // ç¡®ä¿cookiesè¢«å‘é€
                                }).then(response => {
                                    if (response.redirected) {
                                        window.location.href = response.url; // å¦‚æœæœ‰é‡å®šå‘ï¼Œè·Ÿéšåˆ°æ–°çš„URL
                                        return;
                                    } else {
                                        response.json().then(data => {
                                            if (data.error) {
                                                alert(data.error);
                                            }
                                        });
                                    }
                                }).catch(error => console.error('Error:', error));
                            }
                            // å¤åˆ¶æ–‡ä»¶
                            else if (is_cp_or_move == true) {
                                fetch(`/copy_to_folder?target_folder_id=${uuid}`, {
                                    method: 'GET',
                                    credentials: 'include', // ç¡®ä¿cookiesè¢«å‘é€
                                }).then(response => {
                                    if (response.redirected) {
                                        window.location.href = response.url; // å¦‚æœæœ‰é‡å®šå‘ï¼Œè·Ÿéšåˆ°æ–°çš„URL
                                        return;
                                    } else {
                                        response.json().then(data => {
                                            if (data.error) {
                                                alert(data.error);
                                            }
                                        });
                                    }
                                }).catch(error => console.error('Error:', error));
                            }
                        }
                    };

                    // åˆ›å»ºå›¾æ ‡å…ƒç´ 
                    const iconElement = document.createElement('span');
                    iconElement.className = 'icon';
                    // åˆ›å»ºæ–‡ä»¶å¤¹åç§°å…ƒç´ 
                    const folderNameElement = document.createElement('span');
                    folderNameElement.textContent = ` ${folderName}`;
                    // å°†å…ƒç´ æ·»åŠ åˆ°folderElementä¸­
                    folderElement.appendChild(toggleButton);
                    folderElement.appendChild(iconElement); // å°†å›¾æ ‡å…ƒç´ æ·»åŠ åˆ°folderElementä¸­ï¼Œç´§è·Ÿåœ¨toggleButtonä¹‹å
                    folderElement.appendChild(folderNameElement);
                    folderElement.appendChild(actionButton); // å°†æŒ‰é’®å…ƒç´ æ·»åŠ åˆ°folderElementä¸­ï¼Œç´§è·Ÿåœ¨folderNameElementä¹‹å

                    parentElement.appendChild(folderElement);
                });
            }
        }

        window.onload = function () {
            const fileTreeRoot = document.getElementById('file-tree');
            buildFileTree('/', fileTreeRoot);
        };
    </script>
</body>

</html>