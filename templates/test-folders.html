<!DOCTYPE html>
<html>

<head>
    <title>文件树</title>
    <style>
        .icon::before {
            content: "📁 ";
        }

        .folder {
            margin-left: 20px;
        }

        .toggle {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            margin-right: 5px;
            border: 1px solid black;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>文件树页面</h2>
    <h3>用户：<span id="username"></span></h3>
    <script>
        // 获取用户名
        fetch('/get_username', {
            method: 'GET',
        })
            .then(response => response.text())  // 将响应转换为文本
            .then(username => {
                document.getElementById('username').textContent = username;
            })
            .catch(error => console.error('Error:', error));
    </script>
    <h3><span id="cp_or_move"></span></h3>
    <script>
        // 获取操作类型
        fetch('/get_cp_or_move', {
            method: 'GET',
        })
            .then(response => response.json())  // 将响应转换为JSON
            .then(data => {
                document.getElementById('cp_or_move').textContent = data.info;  // 使用info字段更新内容
            })
            .catch(error => console.error('Error:', error));
    </script>
    <div id="file-tree"></div>
    <script>
        async function getFolders(parentFolderId = '/') {
            try {
                const response = await fetch(`/getfolders?parent_folder_id=${parentFolderId}`, {
                    method: 'GET',
                    // 需要添加适当的headers，例如用于认证的Cookie
                });
                const folders = await response.json();
                if (response.ok) {
                    return folders;
                } else {
                    throw new Error('Failed to fetch folders');
                }
            } catch (error) {
                console.error('Error fetching folders:', error);
                return {};
            }
        }

        async function buildFileTree(parentFolderId, parentElement, level = 0) {
            const folders = await getFolders(parentFolderId);
            if (Object.keys(folders).length === 0) {
                const noFolderMsg = document.createElement('div');
                noFolderMsg.textContent = '无文件夹';
                parentElement.appendChild(noFolderMsg);
            } else {
                Object.entries(folders).forEach(([uuid, folderName]) => {
                    // 创建文件夹元素
                    const folderElement = document.createElement('div');
                    folderElement.className = 'folder';
                    folderElement.style.marginLeft = `${level * 20}px`;

                    // 创建toggleButton元素
                    const toggleButton = document.createElement('span');
                    toggleButton.className = 'toggle';
                    toggleButton.textContent = '+';
                    toggleButton.onclick = function (event) {
                        event.stopPropagation(); // 防止事件冒泡
                        if (toggleButton.textContent === '+') {
                            // 展开子文件夹
                            buildFileTree(uuid, folderElement, level + 1).then(() => {
                                toggleButton.textContent = '-';
                            });
                        } else {
                            // 收起子文件夹
                            while (folderElement.lastChild !== folderNameElement) {
                                folderElement.removeChild(folderElement.lastChild);
                            }
                            toggleButton.textContent = '+';
                        }
                    };
                    // 创建按钮元素，移动或复制
                    var is_cp_or_move = false;// 移动为false，复制为true
                    // 创建操作按钮
                    const actionButton = document.createElement('button');
                    actionButton.id = uuid;
                    var cp_or_move_test = document.getElementById('cp_or_move').textContent;
                    if (cp_or_move_test == '复制 ： 选择目标文件夹') {
                        is_cp_or_move = true;
                        actionButton.textContent = '复制到此文件夹';
                    } else if (cp_or_move_test == '移动 ： 选择目标文件夹') {
                        is_cp_or_move = false;
                        actionButton.textContent = '移动到此文件夹';
                    } else {
                        is_cp_or_move = null;
                        actionButton.textContent = '未知操作';
                    }
                    // 为按钮添加点击事件处理函数
                    actionButton.onclick = function () {
                        // 在这里添加移动或复制文件到文件夹的逻辑
                        if (is_cp_or_move != null) {
                            // 移动文件
                            if (is_cp_or_move == false) {
                                fetch(`/move_to_folder?target_folder_id=${uuid}`, {
                                    method: 'GET',
                                    credentials: 'include', // 确保cookies被发送
                                }).then(response => {
                                    if (response.redirected) {
                                        window.location.href = response.url; // 如果有重定向，跟随到新的URL
                                        return;
                                    } else {
                                        response.json().then(data => {
                                            if (data.error) {
                                                alert(data.error);
                                            }
                                        });
                                    }
                                }).catch(error => console.error('Error:', error));
                            }
                            // 复制文件
                            else if (is_cp_or_move == true) {
                                fetch(`/copy_to_folder?target_folder_id=${uuid}`, {
                                    method: 'GET',
                                    credentials: 'include', // 确保cookies被发送
                                }).then(response => {
                                    if (response.redirected) {
                                        window.location.href = response.url; // 如果有重定向，跟随到新的URL
                                        return;
                                    } else {
                                        response.json().then(data => {
                                            if (data.error) {
                                                alert(data.error);
                                            }
                                        });
                                    }
                                }).catch(error => console.error('Error:', error));
                            }
                        }
                    };

                    // 创建图标元素
                    const iconElement = document.createElement('span');
                    iconElement.className = 'icon';
                    // 创建文件夹名称元素
                    const folderNameElement = document.createElement('span');
                    folderNameElement.textContent = ` ${folderName}`;
                    // 将元素添加到folderElement中
                    folderElement.appendChild(toggleButton);
                    folderElement.appendChild(iconElement); // 将图标元素添加到folderElement中，紧跟在toggleButton之后
                    folderElement.appendChild(folderNameElement);
                    folderElement.appendChild(actionButton); // 将按钮元素添加到folderElement中，紧跟在folderNameElement之后

                    parentElement.appendChild(folderElement);
                });
            }
        }

        window.onload = function () {
            const fileTreeRoot = document.getElementById('file-tree');
            buildFileTree('/', fileTreeRoot);
        };
    </script>
</body>

</html>